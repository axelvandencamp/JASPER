SELECT DISTINCT	p.id, p.membership_start, 
	'BUS' productID,
	p.membership_nbr lidnr, p.name, p.street straat_plus_nr,
	CASE
		WHEN c.id = 21 AND p.crab_used = 'true' THEN ccs.name
		ELSE p.street
	END "street_id/name",
	CASE
		WHEN c.id = 21 AND p.crab_used = 'true' THEN p.street_nbr ELSE ''
	END street_nbr, 
	COALESCE(p.street_bus,'') street_bus,
	CASE
		WHEN c.id = 21 AND p.crab_used = 'true' THEN cc.zip
		ELSE p.zip
	END zip,
	CASE 
		WHEN c.id = 21 THEN cc.name ELSE p.city 
	END city,
	COALESCE(p.date_lidkaart::text,'') date_lidkaart, p.lidkaart,
	p.date_welkomstpakket, p.welkomstpakket,
	COALESCE(mm1.name,'') tijdschrift_1,
	COALESCE(mm2.name,'') tijdschrift_2,
	mo.name herkomst_lidmaatschap,
	p.membership_state huidige_lidmaatschap_status,
	CASE
		WHEN p.country_id = 21 THEN 'BE' ELSE c.name
	END AS Country,
	'Natuurpunt' "Sender Name", '' "Sender Contact Name", 'Coxiestraat' "Sender Street", '11' "Sender Street Number", '' "Sender Box Number", 
	'2800' "Sender Postal Code", 'Mechelen' "Sender City",
	type_lid
FROM res_partner p
	JOIN (
		
		SELECT id, 'N' as type_lid
		FROM res_partner p
		WHERE 	(membership_nbr >  $P{Lidnummer} AND NOT(membership_start IS NULL)) OR (membership_nbr >  $P{Lidnummer} AND free_member)
						AND NOT(membership_state = 'none') AND NOT(membership_state = 'wait_member')
		
		UNION ALL
		
		SELECT id, 'O1' as type_lid
		FROM res_partner p
		WHERE membership_nbr < $P{Lidnummer}   
			AND membership_pay_date >=  $P{membership_start}  
			AND date_part('year',age(membership_stop, membership_start)) <= 0
			AND NOT(membership_start IS NULL)
			AND NOT (id IN (SELECT id FROM _crm_ledenviaafdeling( $P{Lidnummer}, $P{membership_start}  )))
			AND NOT (id IN (SELECT id FROM _crm_ledenmetdomi( $P{Lidnummer}, $P{membership_start}  )))
			AND NOT (id IN (SELECT id FROM _crm_ledenviateinnenoverschrijving( $P{Lidnummer}, $P{membership_start}  )))
		
		UNION ALL
		
		SELECT id, '5' as type_lid FROM _crm_leden5j($P{Lidnummer},$P{membership_start})
		
		UNION ALL
		
		SELECT id, 'V' as type_lid FROM _crm_ledennieuwlatergevalideerd( $P{Lidnummer},  $P{membership_start})
		
		UNION ALL
		
		SELECT id, 'O2' as type_lid FROM _crm_ledenoudepartnernieuwlid( $P{Lidnummer} ,  $P{membership_start})
		
	) x
	ON x.id = p.id
	JOIN res_country c ON p.country_id = c.id
	LEFT OUTER JOIN res_country_city_street ccs ON p.street_id = ccs.id
	LEFT OUTER JOIN res_country_city cc ON p.zip_id = cc.id

	LEFT OUTER JOIN res_partner_membership_origin mo ON p.membership_origin_id = mo.id
	--tijdschrift 1 en/of - 2
	LEFT OUTER JOIN mailing_mailing mm1 ON p.periodical_1_id = mm1.id
	LEFT OUTER JOIN mailing_mailing mm2 ON p.periodical_2_id = mm2.id
WHERE 
	NOT (p.id IN (SELECT id FROM _crm_ledenmetinactievedubbel()))
	AND COALESCE(p.lidkaart,'false') = 'false'
	AND p.membership_start < now()::date
	AND NOT(p.membership_state = 'wait_member')
